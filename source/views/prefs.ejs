<% include header %>

      <script>
      function forwardTweetsHistory(account) {

        $.ajax({
            type: 'GET',
            url: '/user-timeline/<%=data.username %>/'+account
        }).done(function(data){
            console.log("done importing");
            $("#"+account).html(Object.keys(data).length+' tweets successfuly imported');
            console.dir(data);
        });
        return false;
      }
      function submitForm() {
        $.ajax({type:'PUT', url: '/user-settings/<%=data.username %>', data:{
          'twitter':{
            'filter':$("#filter").val(),
            'filterOption':$('#filterOption').val()}}, dataType:'json', success: function(response) {
          console.log($('#filterOption').val());
          $('#formResult').html('update successful');
          console.log(response);
        }});
        return false;
      }
      </script>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="brand" href="#">Pryv: Twitter integration</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li><a href="/">Home</a></li>
              <li class="active"><a>Preferences</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container">

      <span id="pryvButton"></span>
      <h2>Twitter integration settings</h2>
      <br />
      <span id="pryvButton"></span>

      <form class="well" action="" method="" onsubmit="return submitForm();" id="prefsForm">
        <label class="select">
          Add the following tweets to my Pryv:<br />
          <select id="filterOption">
            <option value="all" <% if (result.twitter.filterOption === 'all') { %>selected<% } %>>All tweets</option>
            <option value="filter" <% if (result.twitter.filterOption === 'filter') { %>selected<% } %>>Only those containing my filter text</option>
            <option value="favorite" <% if (result.twitter.filterOption === 'favorite') { %>selected<% } %>>Only my favorite tweets</option>
          </select>
        </label>

        <label>Filter text</label>
        <input id="filter" type="text" class="span3" placeholder="Set your filter" value="<%= result.twitter.filter %>">
        <span class="help-inline">If the filter is active, only tweets containing this text will be added to Pryv</span>

        <div id="formResult"></div>

        <button type="submit" class="btn">Submit</button>
      </form>

      <% result.twitter.credentials.forEach(function(credential){
        if (credential.accessToken !== '') {%>
      <form class="well">
        Pryv is connected to the Twitter account <b><%= credential.username %></b>. New tweets will automatically be added to your Pryv based on your preferences.
        <br /><br /><button class="btn" type="button" onclick="forwardTweetsHistory('<%= credential.username %>')">Import tweets</button><span class="help-inline">&nbsp;max. 3200 tweets</span>
        <div id="<%= credential.username %>"></div>
      </form>
      <% }}) %>

      <p><a href="/auth">Add a new Twitter account</a></p>
      <p>To revoke the access, go to <a href="https://twitter.com/settings/applications" target="_blank">the Twitter settings</a> of your corresponding account.</p><br />


      <script>
      //TODO: remove this debugging script
      var connection = new pryv.Connection({username:'perkikiki', auth:'VPoFEsuJRM', staging: true});

      var eventData = { streamId : 'social-twitter', type: 'message/twitter', content: {id: '1234', 'screen-name':'balbla'} };
      connection.events.create(eventData, function(err, event) {
        console.log('Event created:');
        console.dir(event);

        connection.events.get({limit : 3}, function (err, events) {
          console.dir(events);
        })
      });
      </script>

    </div>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
  </body>
</html>
